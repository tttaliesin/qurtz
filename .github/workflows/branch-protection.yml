name: Branch Protection

on:
  workflow_dispatch:

jobs:
  post-merge-validation:
    name: Post-Merge Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Final validation
        run: |
          echo "ğŸ” ë³‘í•© í›„ ê²€ì¦ ì‹¤í–‰ ì¤‘..."
          
          # main ë¸Œëœì¹˜ê°€ ì—¬ì „íˆ ìœ íš¨í•œì§€ í™•ì¸
          helm lint .
          helm template qurtz . --values values.yaml > /dev/null
          helm template qurtz-test . --values test-values.yaml > /dev/null
          
          echo "âœ… Main ë¸Œëœì¹˜ ê²€ì¦ í†µê³¼"

      - name: Check version bump
        run: |
          # ì°¨íŠ¸ ë²„ì „ í™•ì¸
          CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          echo "í˜„ì¬ ì°¨íŠ¸ ë²„ì „: $CHART_VERSION"
          
          # ì´ì „ ë²„ì „ê³¼ ë¹„êµí•´ì„œ ë²„ì „ì´ ì¦ê°€í–ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ í™•ì¥ ê°€ëŠ¥
          echo "ğŸ“Š ì°¨íŠ¸ ë²„ì „ í™•ì¸ ì™„ë£Œ"

      - name: Update status
        run: |
          echo "ğŸ‰ Main ë¸Œëœì¹˜ ì •ìƒ ìƒíƒœ, í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ!"

  create-release-draft:
    name: Create Release Draft
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && contains(github.event.head_commit.message, 'feat:')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get chart version
        id: version
        run: |
          CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          echo "version=$CHART_VERSION" >> $GITHUB_OUTPUT

      - name: Create release draft
        run: |
          # ìƒˆë¡œìš´ ê¸°ëŠ¥ì— ëŒ€í•œ ë¦´ë¦¬ìŠ¤ ì´ˆì•ˆ ìƒì„±
          gh release create "v${{ steps.version.outputs.version }}" \
            --draft \
            --title "Qurtz Helm Chart v${{ steps.version.outputs.version }}" \
            --notes "ë²„ì „ ${{ steps.version.outputs.version }}ì— ëŒ€í•œ ìë™ ìƒì„±ëœ ë¦´ë¦¬ìŠ¤ ì´ˆì•ˆ" \
            --target main || echo "ë¦´ë¦¬ìŠ¤ê°€ ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}