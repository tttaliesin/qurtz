name: Test and Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  push:
    branches: [main]

env:
  HELM_VERSION: "3.14.0"
  KUBERNETES_VERSION: "1.30.0"

jobs:
  helm-lint:
    name: Helm Chart Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '${{ env.HELM_VERSION }}'

      - name: Helm lint
        run: |
          helm lint .
          echo "âœ… Helm ì°¨íŠ¸ ë¦°íŒ… í†µê³¼"

      - name: Helm template validation
        run: |
          helm template qurtz . --values values.yaml > /tmp/manifests.yaml
          helm template qurtz-test . --values test-values.yaml > /tmp/test-manifests.yaml
          echo "âœ… Helm í…œí”Œë¦¿ ìƒì„± ì„±ê³µ"

  chart-validation:
    name: Chart Structure Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Chart structure
        run: |
          # í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸
          test -f Chart.yaml || (echo "âŒ Chart.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          test -f values.yaml || (echo "âŒ values.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          test -d templates || (echo "âŒ templates ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          
          # í•„ìˆ˜ í…œí”Œë¦¿ í™•ì¸
          test -f templates/watcher-deployment.yaml || (echo "âŒ watcher-deployment.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          test -f templates/service.yaml || (echo "âŒ service.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          test -f templates/configmap.yaml || (echo "âŒ configmap.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          test -f templates/nfs-pv.yaml || (echo "âŒ nfs-pv.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          test -f templates/nginx-configmap.yaml || (echo "âŒ nginx-configmap.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          
          echo "âœ… ì°¨íŠ¸ êµ¬ì¡° ê²€ì¦ í†µê³¼"

      - name: Check Chart.yaml version
        run: |
          CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          echo "ì°¨íŠ¸ ë²„ì „: $CHART_VERSION"
          
          # ë²„ì „ í˜•ì‹ ê²€ì¦ (ì‹œë§¨í‹± ë²„ì €ë‹)
          if [[ ! $CHART_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "âŒ ì˜ëª»ëœ ì°¨íŠ¸ ë²„ì „ í˜•ì‹: $CHART_VERSION"
            exit 1
          fi
          echo "âœ… ì°¨íŠ¸ ë²„ì „ í˜•ì‹ ìœ íš¨"

  kubernetes-dry-run:
    name: Kubernetes Dry Run Test
    runs-on: ubuntu-latest
    needs: [helm-lint, chart-validation]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '${{ env.HELM_VERSION }}'

      - name: Create fake kubeconfig for dry run
        run: |
          mkdir -p ~/.kube
          # Dry run í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ê°€ì§œ kubeconfig ìƒì„±
          cat > ~/.kube/config << EOF
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: https://fake-server:6443
            name: fake-cluster
          contexts:
          - context:
              cluster: fake-cluster
              user: fake-user
            name: fake-context
          current-context: fake-context
          users:
          - name: fake-user
          EOF

      - name: Kubernetes dry run test
        run: |
          # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ë° YAML ë¬¸ë²• ê²€ì¦
          helm template qurtz . --values test-values.yaml > manifests.yaml
          
          # YAML ë¬¸ë²• ê²€ì¦ (yq ì‚¬ìš©)
          if ! yq eval '.' manifests.yaml > /dev/null 2>&1; then
            echo "âŒ YAML ë¬¸ë²• ì˜¤ë¥˜ ë°œê²¬"
            exit 1
          fi
          
          echo "âœ… Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ë° YAML ë¬¸ë²• ê²€ì¦ í†µê³¼"

      - name: Resource validation
        run: |
          # í•„ìˆ˜ ë¦¬ì†ŒìŠ¤ ìƒì„± í™•ì¸
          grep -q "kind: Deployment" manifests.yaml || (echo "âŒ Deployment ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          grep -q "kind: Service" manifests.yaml || (echo "âŒ Service ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          grep -q "kind: ConfigMap" manifests.yaml || (echo "âŒ ConfigMap ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          grep -q "kind: PersistentVolume" manifests.yaml || (echo "âŒ PersistentVolume ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          grep -q "kind: PersistentVolumeClaim" manifests.yaml || (echo "âŒ PersistentVolumeClaim ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          
          # ë°°í¬ì— ì˜¬ë°”ë¥¸ ì»¨í…Œì´ë„ˆê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          grep -q "name: file-watcher" manifests.yaml || (echo "âŒ file-watcher ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          grep -q "name: quartz-builder" manifests.yaml || (echo "âŒ quartz-builder ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          grep -q "name: web-server" manifests.yaml || (echo "âŒ web-server ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" && exit 1)
          
          echo "âœ… ë¦¬ì†ŒìŠ¤ ê²€ì¦ í†µê³¼"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          # ì ì¬ì ì¸ ë¹„ë°€ì •ë³´ í™•ì¸ (ê¸°ë³¸ íŒ¨í„´)
          if grep -r -i "password\|secret\|token\|key" --include="*.yaml" --include="*.yml" .; then
            echo "âš ï¸  YAML íŒŒì¼ì—ì„œ ì ì¬ì ì¸ ë¹„ë°€ì •ë³´ ë°œê²¬ - ê²€í†  í•„ìš”"
            # ë¹Œë“œ ì‹¤íŒ¨ì‹œí‚¤ì§€ ì•Šê³  ê²½ê³ ë§Œ í‘œì‹œ
          fi
          echo "âœ… ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ"

      - name: Validate image sources
        run: |
          # ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì¶”ì¶œ ë° ê²€ì¦
          helm template qurtz . --values test-values.yaml | grep "image:" | while read -r line; do
            image=$(echo "$line" | awk '{print $2}' | tr -d '"')
            echo "ë°œê²¬ëœ ì´ë¯¸ì§€: $image"
            
            # ì•Œë ¤ì§„ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë ˆì§€ìŠ¤íŠ¸ë¦¬ í™•ì¸
            if [[ "$image" =~ ^(alpine|node|nginx): ]]; then
              echo "âœ… ê³µì‹ ì´ë¯¸ì§€ ì‚¬ìš© ì¤‘: $image"
            else
              echo "âš ï¸  ë¹„ê³µì‹ ì´ë¯¸ì§€ ê°ì§€: $image"
            fi
          done

  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    needs: [helm-lint, chart-validation, kubernetes-dry-run, security-scan]
    if: github.event_name == 'pull_request' && github.actor == 'tttaliesin'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PR status
        id: pr-check
        run: |
          # ëª¨ë“  í•„ìˆ˜ ê²€ì‚¬ê°€ í†µê³¼í–ˆëŠ”ì§€ í™•ì¸
          echo "ëª¨ë“  í•„ìˆ˜ ê²€ì‚¬ í†µê³¼ âœ…"
          echo "ready_to_merge=true" >> $GITHUB_OUTPUT

      - name: Auto approve PR
        if: steps.pr-check.outputs.ready_to_merge == 'true'
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve --body "ğŸ¤– ìë™ ìŠ¹ì¸ - ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto merge PR
        if: steps.pr-check.outputs.ready_to_merge == 'true'
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch --body "ğŸ¤– í…ŒìŠ¤íŠ¸ ì„±ê³µ í›„ ìë™ ë³‘í•©"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post merge comment
        if: steps.pr-check.outputs.ready_to_merge == 'true'
        run: |
          echo "ğŸ‰ PR ì„±ê³µì ìœ¼ë¡œ ë³‘í•©! ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼."

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [helm-lint, chart-validation, kubernetes-dry-run, security-scan]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Check overall status
        run: |
          if [[ "${{ needs.helm-lint.result }}" == "success" && 
                "${{ needs.chart-validation.result }}" == "success" && 
                "${{ needs.kubernetes-dry-run.result }}" == "success" && 
                "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼! ë³‘í•© ì¤€ë¹„ ì™„ë£Œ."
            exit 0
          else
            echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            exit 1
          fi